/**!
 * Jinn -- Notifications center
 * https://github.com/RubaXa/Jinn#readme
 *
 * @author	RubaXa	<trash@rubaxa.org>
 * @build	Jinn.OS, Jinn.bubble
 * @example
 *
 * 	Jinn
 * 		.bubble(10)
 * 		.scope('menu')
 * 			.bubble(5)
 * 			.say({ ... })
 * 		.store('key', '...') // set
 * 	;
 *
 *  // Jinn.access -- should be invoked on user action
 * 	Jinn.access(function (){
 * 		var notify = Jinn.say({ icon: '..', title: '...', text: '...' });
 * 		notify.onclick = function (){   };
 * 	});
 *
 * 	var val = Jinn.store('key'); // get
 * 	Jinn.store('key', null); // remove
 */
(function(){var e=void 0,f=null,g=window;function h(){}function i(a){this.g=a}var j=navigator.userAgent.toLowerCase(),k={scope:"OS"},l={},m={},n,p;function q(){p||(p=1,clearTimeout(n),n=setTimeout(s,10))}function s(){var a,b,c;for(a in m){b=t.store("__event."+a);for(c=m[a].length;c--;)m[a][c](b)}p=0}i.ext=function(a){function b(){this.__lego.apply(this,arguments)}var c;h.prototype=this.fn;b.prototype=b.fn=new h;b.ext=i.ext;b.methods=i.methods;for(c in a)b.fn[c]=a[c];return b};
i.methods=function(a){for(var b in a)this.fn[b]=a[b];return this};
i.prototype=i.fn={ALLOWED:0,NOT_ALLOWED:1,DENIED:2,_opts:{},__lego:h,_check:function(){return this.ALLOWED},_request:function(a){a()},_ext:function(a){for(var b in this._opts)a[b]===e&&(a[b]=this._opts[b]);return a},opt:function(a,b){var c=this;if(b!==e)c._opts[a]=b;else if("object"==typeof a)for(b in a)c._opts[b]=a[b];else c=c._opts[a];return c},access:function(a){if(a){if(!a.c){var b=this;a.c=function(){a.call(b)}}this.hasRight()?a.c():this._request(a.c)}else return this._check()},hasRight:function(){return this.access()==
this.ALLOWED},hasAccessDenied:function(){return this.access()==this.DENIED},add:h,say:function(){return this.add.apply(this,arguments)},bubble:function(){},end:function(){return t}};
var t={API:i,opt:function(a,b){if(b===e)return k[a];k[a]=b;return t},on:function(a,b){m[a]||(m[a]=[]);m[a].push(b);return t},off:function(a,b){if(a in m)for(var c=m[a],d=c.length;d--;)if(c[d]===b){c.splice(d,1);break}return t},emit:function(a,b){t.store("__event."+a,b);q()},scope:function(a,b){var c=t;if(a==e)c=t.scope(k.scope);else if(b!==e)l[a]=b;else if(a in l)c=l[a];else throw'Jinn: scope "'+a+'" is undefined';return c},e:function(a,b,c){if(a){var d=a.addEventListener?"":"on";a[d?"attachEvent":
"addEventListener"](d+b,c,!1)}}},u="hasRight hasAccessDenied access bubble add say".split(" "),v=u.length;for(;v--;)(function(a){t[a]=function(){var b=t.scope(),c=b[a].apply(b,arguments);return c===b?t:c}})(u[v]);t.store=function(a,b){var c=t,d=t.scope("__store");b===f?d.remove("__jinn."+a):b===e?c=d.get("__jinn."+a):d.set("__jinn."+a,b);return c};var w=g.localStorage,x={};
t.scope("__store",{get:function(a){return w?w.getItem(a):x[a]},set:function(a,b){w?w.setItem(a,b):x[a]=b},remove:function(a){delete x[a];w&&w.removeItem(a)}});t[(j.match(/webkit/)||j.match(/opera/)||j.match(/msie/)||0>j.indexOf("compatible")&&j.match(/mozilla/)||[])[0]]=!0;t.webkit&&(t[(j.match(/chrome/)||j.match(/safari/)||[])[0]]=!0);t.e(g,"storage",q);g.Jinn=t;
var y=document,z=Jinn,A=window.webkitNotifications,B=z.API.ext({_tpl:"#JinnOSTpl",_opts:{title:"",text:"",delay:60},tpl:function(a){this._tpl=a;return this},add:function(a){"string"==typeof a&&(a={title:a});this._ext(a);var b=this._create(a);b.show();a.delay&&setTimeout(function(){b.cancel()},1E3*a.delay);return b}});
if(A)B.methods({_check:function(){return A.checkPermission()},_request:function(a){A.requestPermission(a)},_create:function(a){try{a=A.createNotification(a.icon,a.title,a.text)}catch(b){throw"Notifications.createNotification \u2014 access denied";}return a}});else{var C=/\{\{(.*?)\}\}/g,D=[],E=function(a,b){if(/^#/.test(a)&&(a=y.getElementById(a.substr(1))))a=a.innerHTML;a&&(this.a=y.createElement("div"),this.a.innerHTML=a.replace(C,function(a,d){return(new Function("notify,v,u","try{v="+d+'}catch(e){} return v===u?"":v'))(b)}),
y.body.appendChild(this.a))};E.d=function(){for(var a=5,b=0,c=D.length;b<c;b++)D[b].a.style.top=a+"px",a+=D[b].a.offsetHeight+5};E.prototype={show:function(){if(this.a){var a=this,b=a.a.style;D.push(a);b.right="5px";b.position="fixed";b.display="block";E.d();a.a.onclick=function(){a.onclick.call(a,{type:"click",target:a,currentTarget:a})}}},cancel:function(){if(this.a){for(var a=0,b=D.length;a<b;a++)D[a]===this&&(D.splice(a,1),E.d());this.a.onclick=f;this.a.parentNode.removeChild(this.a);this.a=f}},
onclick:function(){}};B.methods({hasRight:function(){return!!this._tpl},_create:function(a){return new E(this._tpl,a)}})}z.scope("OS",new (z.OS=B));var F=document,G=Jinn;function H(){}var I=/(^|\s)icon(\s|$)/,J=/^data/,K,L,M=f,N=new Image,O=0,P={val:M,fps:2,iconX:0,iconY:0,iconW:16,iconH:16};function Q(a){for(var b=F.getElementsByTagName("link"),c=b.length;c--;)if(I.test(b[c].getAttribute("rel"))&&!0===a(b[c]))return b[c]}
function R(a){S.b();Q(function(a){a.parentNode.removeChild(a)});var b=F.createElement("link");b.rel="icon";b.type="image/png";b.href=a;F.getElementsByTagName("head")[0].appendChild(b)}var T=F.createElement("canvas"),U;a:{try{U=!!~T.toDataURL("image/png").indexOf("data:image/png");break a}catch(V){}U=e}
P.shape=function(a,b,c){var d=15.5,b=99<b?(d+=0.5,"99+"):b;a.font=(G.h?"bold ":"")+"9px arial";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=2;a.shadowColor="rgba(0,0,0,.5)";a.fillStyle=c?"#fc3":"#fff";a.textAlign="right";a.fillText(b,d,15);a.fillText(b,d,15);a.fillText(b,d,15)};
var S={b:function(){S.b=H;S.f=1;var a=Q(function(){return!0});a&&(L=a.href,S.opt("src",P.src||L))},src:function(a){return S.opt("src",a)},shape:function(a){S.opt("shape",a);return this},opt:function(a,b){var c=S.f||P.val||"shape"==a;if("string"==typeof a){if(b===e)return P[a];P[a]=b}else for(var d in a)P[d]=a[d],c=c||"shape"==d;b=P.val;if(c){var r=b;if(U&&(N.src!=P.src||M!=r))if(S.b(),T.width=T.height=16,N.src=P.src,N.onload=function(){function a(){var b=T.getContext("2d");b.clearRect(0,0,16,16);
b.drawImage(N,0,0,N.width,N.height,P.iconX,P.iconY,P.iconW,P.iconH);P.shape(b,r,O,P);R(T.toDataURL());P.fps<=++O&&(O=0)}clearInterval(K);r===f||r===e||!P.fps?O=0:K=setInterval(a,~~(1E3/P.fps+0.5));r===f||r===e?R(P.src):a()},J.test(N.src)?(N.crossOrigin=f,N.removeAttribute("crossOrigin")):N.crossOrigin="anonymous",N.width)N.onload()}b!==M&&G.emit("bubble:val",b);M=b},set:function(a){S.b();S.opt("val",a)},revert:function(){S.opt("src",L)},reset:function(){S.opt({src:L,val:f})},clear:function(){S.opt("val",
f)}};G.OS.Bubble=S;G.scope("OS").bubble=function(a,b){if("object"==typeof a&&a!==f)S.opt(a);else if(a in S)S[a](b);else S.set(a);return G};G.on("bubble:val",function(a){S.set(a)});"undefined"!==typeof ajs&&ajs.loaded&&ajs.loaded("{jinn}Jinn.min");"function"===typeof define&&define.amd&&define("Jinn",[],function(){return window.Jinn||{}});})()