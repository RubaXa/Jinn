/**!
 * Jinn -- Notifications center
 * https://github.com/RubaXa/Jinn#readme
 *
 * @author	RubaXa	<trash@rubaxa.org>
 * @build	Jinn.OS, Jinn.bubble
 * @example
 *
 * 	Jinn
 * 		.bubble(10)
 * 		.scope('menu')
 * 			.bubble(5)
 * 			.say({ ... })
 * 		.store('key', '...') // set
 * 	;
 *
 *  // Jinn.access -- should be invoked on user action
 * 	Jinn.access(function (){
 * 		var notify = Jinn.say({ icon: '..', title: '...', text: '...' });
 * 		notify.onclick = function (){   };
 * 	});
 *
 * 	var val = Jinn.store('key'); // get
 * 	Jinn.store('key', null); // remove
 */
(function(){var l=null;
(function(o,h,i){function m(){var b,c,a;for(b in n){c=f.store("__event."+b);for(a=n[b].length;a--;)n[b][a](c)}p=0}function r(){p||(p=1,clearTimeout(t),t=setTimeout(m,10))}function g(){}function k(){}var h=navigator.userAgent.toLowerCase(),a={scope:"OS"},d={},n={},t,p;g.ext=function(b){function c(){this.__lego.apply(this,arguments)}var a;k.prototype=this.fn;c.prototype=c.fn=new k;c.ext=g.ext;c.methods=g.methods;for(a in b)c.fn[a]=b[a];return c};g.methods=function(b){for(var c in b)this.fn[c]=b[c];
return this};g.prototype=g.fn={ALLOWED:0,NOT_ALLOWED:1,DENIED:2,_opts:{},__lego:k,_check:function(){return this.ALLOWED},_request:function(b){b()},_ext:function(b){for(var c in this._opts)b[c]===i&&(b[c]=this._opts[c]);return b},opt:function(b,c){var a=this;if(c!==i)a._opts[b]=c;else if("object"==typeof b)for(c in b)a._opts[c]=b[c];else a=a._opts[b];return a},access:function(b){if(b){if(!b.c){var c=this;b.c=function(){b.call(c)}}this.hasRight()?b.c():this._request(b.c)}else return this._check()},
hasRight:function(){return this.access()==this.ALLOWED},add:k,say:function(){return this.add.apply(this,arguments)},bubble:function(){},end:function(){return f}};var f={API:g,opt:function(b,c){if(c===i)return a[b];a[b]=c;return f},on:function(b,c){n[b]||(n[b]=[]);n[b].push(c);return f},off:function(b,c){if(b in n)for(var a=n[b],e=a.length;e--;)if(a[e]===c){a.splice(e,1);break}return f},emit:function(b,a){f.store("__event."+b,a);r()},scope:function(b,c){var s=f;if(b==i)s=f.scope(a.scope);else if(c!==
i)d[b]=c;else if(b in d)s=d[b];else throw'Jinn: scope "'+b+'" is undefined';return s},e:function(b,a,d){if(b){var e=b.addEventListener?"":"on";b[e?"attachEvent":"addEventListener"](e+a,d,!1)}return f}},j=["access","bubble","add","say"],q=j.length;for(;q--;)(function(b){f[b]=function(){var a=f.scope(),d=a[b].apply(a,arguments);return d===a?f:d}})(j[q]);f.store=function(b,a){var d=f,e=f.scope("__store");a===l?e.remove("__jinn."+b):a===i?d=e.get("__jinn."+b):e.set("__jinn."+b,a);return d};(function(b,
a){f.scope("__store",{get:function(d){return b?b.getItem(d):a[d]},set:function(d,e){b?b.setItem(d,e):a[d]=e},remove:function(d){delete a[d];b&&b.removeItem(d)}})})(o.localStorage,{});f[(h.match(/webkit/)||h.match(/opera/)||h.match(/msie/)||0>h.indexOf("compatible")&&h.match(/mozilla/)||[])[0]]=!0;f.webkit&&(f[(h.match(/chrome/)||h.match(/safari/)||[])[0]]=!0);f.e(o,"storage",r);o.Jinn=f})(window,document);
(function(o,h,i,m){o=i.API.ext({_tpl:"#JinnOSTpl",_opts:{title:"",text:""},tpl:function(a){this._tpl=a;return this},add:function(a){"string"==typeof a&&(a={title:a});this._ext(a);var d=this._create(a);d.show();a.delay&&setTimeout(function(){d.cancel()},1E3*a.delay);return d}});if(m)o.methods({_check:function(){return m.checkPermission()},_request:function(a){m.requestPermission(a)},_create:function(a){return m.createNotification(a.icon,a.title,a.text)}});else{var r=/\{\{(.*?)\}\}/g,g=[],k=function(a,
d){this.a=h.createElement("div");this.a.innerHTML=("#"==a.charAt(0)?h.getElementById(a.substr(1)).innerHTML:a).replace(r,function(a,g){return(new Function("notify,v,u","try{v="+g+'}catch(e){} return v===u?"":v'))(d)});h.body.appendChild(this.a)};k.d=function(){for(var a=5,d=0,h=g.length;d<h;d++)g[d].a.style.top=a+"px",a+=g[d].a.offsetHeight+5};k.prototype={show:function(){if(this.a){var a=this,d=a.a.style;g.push(a);d.right="5px";d.position="fixed";d.display="block";k.d();a.a.onclick=function(){a.onclick()}}},
cancel:function(){if(this.a){for(var a=0,d=g.length;a<d;a++)g[a]===this&&(g.splice(a,1),k.d());this.a.onclick=l;this.a.parentNode.removeChild(this.a);this.a=l}},onclick:function(){}};o.methods({hasRight:function(){return!!this._tpl},_create:function(a){return new k(this._tpl,a)}})}i.scope("OS",new (i.OS=o))})(window,document,Jinn,window.webkitNotifications);
(function(o,h,i,m){function r(a){if(s&&(j.src!=b.src||f!=a))if(e.b(),c.width=c.height=16,j.src=b.src,j.onload=function(){function d(){var e=c.getContext("2d");e.clearRect(0,0,16,16);e.drawImage(j,0,0,j.width,j.height,b.iconX,b.iconY,b.iconW,b.iconH);b.shape(e,a,q,b);g(c.toDataURL());b.fps<=++q&&(q=0)}clearInterval(t);a===l||a===m||!b.fps?q=0:t=setInterval(d,~~(1E3/b.fps+0.5));a===l||a===m?g(b.src):d()},n.test(j.src)?(j.crossOrigin=l,j.removeAttribute("crossOrigin")):j.crossOrigin="anonymous",j.width)j.onload()}
function g(b){e.b();k(function(a){a.parentNode.removeChild(a)});var a=h.createElement("link");a.rel="icon";a.type="image/png";a.href=b;h.getElementsByTagName("head")[0].appendChild(a)}function k(a){for(var b=h.getElementsByTagName("link"),c=b.length;c--;)if(d.test(b[c].getAttribute("rel"))&&!0===a(b[c]))return b[c]}function a(){}var d=/\bicon\b/,n=/^data/,t,p,f=l,j=new Image,q=0,b={val:f,fps:2,iconX:0,iconY:0,iconW:16,iconH:16},c=h.createElement("canvas"),s=c.getContext&&!!~c.toDataURL("image/png").indexOf("data:image/png");
b.shape=function(a,b,c){var d=15.5,b=99<b?(d+=0.5,"99+"):b;a.font=(i.g?"bold ":"")+"9px arial";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=2;a.shadowColor="rgba(0,0,0,.5)";a.fillStyle=c?"#fc3":"#fff";a.textAlign="right";a.fillText(b,d,15);a.fillText(b,d,15);a.fillText(b,d,15)};var e={b:function(){e.b=a;e.f=1;var c=k(function(){return!0});c&&(p=c.href,e.opt("src",b.src||p))},src:function(a){return e.opt("src",a)},shape:function(a){e.opt("shape",a);return this},opt:function(a,c){var d=e.f||b.val||
"shape"==a;if("string"==typeof a){if(c===m)return b[a];b[a]=c}else for(var g in a)b[g]=a[g],d=d||"shape"==g;c=b.val;d&&r(c);c!==f&&i.emit("bubble:val",c);f=c},set:function(a){e.b();e.opt("val",a)},revert:function(){e.opt("src",p)},reset:function(){e.opt({src:p,val:l})},clear:function(){e.opt("val",l)}};i.OS.Bubble=e;i.scope("OS").bubble=function(a,b){if("object"==typeof a&&a!==l)e.opt(a);else if(a in e)e[a](b);else e.set(a);return i};i.on("bubble:val",function(a){e.set(a)})})(window,document,Jinn);
window.ajs&&ajs.loaded&&ajs.loaded("{Jinn}Jinn.min");"function"===typeof define&&define.amd&&define("Jinn",[],function(){return window.Jinn||{}});
})()