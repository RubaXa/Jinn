/**!
 * Jinn -- Notifications center
 * https://github.com/RubaXa/Jinn#readme
 *
 * @author	RubaXa	<trash@rubaxa.org>
 * @build	Jinn.OS, Jinn.bubble
 * @example
 *
 * 	Jinn
 * 		.bubble(10)
 * 		.scope('menu')
 * 			.bubble(5)
 * 			.say({ ... })
 * 		.store('key', '...') // set
 * 	;
 *
 *  // Jinn.access -- should be invoked on user action
 * 	Jinn.access(function (){
 * 		var notify = Jinn.say({ icon: '..', title: '...', text: '...' });
 * 		notify.onclick = function (){   };
 * 	});
 *
 * 	var val = Jinn.store('key'); // get
 * 	Jinn.store('key', null); // remove
 */
(function(){var e=void 0,f=null,g=window;function h(){}function i(a){this.g=a}var j=navigator.userAgent.toLowerCase(),k={scope:"OS"},l={},m={},n,o;function p(){o||(o=1,clearTimeout(n),n=setTimeout(q,10))}function q(){var a,b,c;for(a in m){b=s.store("__event."+a);for(c=m[a].length;c--;)m[a][c](b)}o=0}i.ext=function(a){function b(){this.__lego.apply(this,arguments)}var c;h.prototype=this.fn;b.prototype=b.fn=new h;b.ext=i.ext;b.methods=i.methods;for(c in a)b.fn[c]=a[c];return b};
i.methods=function(a){for(var b in a)this.fn[b]=a[b];return this};
i.prototype=i.fn={ALLOWED:0,NOT_ALLOWED:1,DENIED:2,_opts:{},__lego:h,_check:function(){return this.ALLOWED},_request:function(a){a()},_ext:function(a){for(var b in this._opts)a[b]===e&&(a[b]=this._opts[b]);return a},opt:function(a,b){var c=this;if(b!==e)c._opts[a]=b;else if("object"==typeof a)for(b in a)c._opts[b]=a[b];else c=c._opts[a];return c},access:function(a){if(a){if(!a.c){var b=this;a.c=function(){a.call(b)}}this.hasRight()?a.c():this._request(a.c)}else return this._check()},hasRight:function(){return this.access()==
this.ALLOWED},hasAccessDenied:function(){return this.access()==this.DENIED},add:h,say:function(){return this.add.apply(this,arguments)},bubble:function(){},end:function(){return s}};
var s={API:i,opt:function(a,b){if(b===e)return k[a];k[a]=b;return s},on:function(a,b){m[a]||(m[a]=[]);m[a].push(b);return s},off:function(a,b){if(a in m)for(var c=m[a],d=c.length;d--;)if(c[d]===b){c.splice(d,1);break}return s},emit:function(a,b){s.store("__event."+a,b);p()},scope:function(a,b){var c=s;if(a==e)c=s.scope(k.scope);else if(b!==e)l[a]=b;else if(a in l)c=l[a];else throw'Jinn: scope "'+a+'" is undefined';return c},e:function(a,b,c){if(a){var d=a.addEventListener?"":"on";a[d?"attachEvent":
"addEventListener"](d+b,c,!1)}}},t="hasRight hasAccessDenied access bubble add say".split(" "),u=t.length;for(;u--;)(function(a){s[a]=function(){var b=s.scope(),c=b[a].apply(b,arguments);return c===b?s:c}})(t[u]);s.store=function(a,b){var c=s,d=s.scope("__store");b===f?d.remove("__jinn."+a):b===e?c=d.get("__jinn."+a):d.set("__jinn."+a,b);return c};var v=g.localStorage,w={};
s.scope("__store",{get:function(a){return v?v.getItem(a):w[a]},set:function(a,b){v?v.setItem(a,b):w[a]=b},remove:function(a){delete w[a];v&&v.removeItem(a)}});s[(j.match(/webkit/)||j.match(/opera/)||j.match(/msie/)||0>j.indexOf("compatible")&&j.match(/mozilla/)||[])[0]]=!0;s.webkit&&(s[(j.match(/chrome/)||j.match(/safari/)||[])[0]]=!0);s.e(g,"storage",p);g.Jinn=s;
var x=document,y=Jinn,z=window.webkitNotifications,A=y.API.ext({_tpl:"#JinnOSTpl",_opts:{title:"",text:"",delay:60},tpl:function(a){this._tpl=a;return this},add:function(a){"string"==typeof a&&(a={title:a});this._ext(a);var b=this._create(a);b.show();a.delay&&setTimeout(function(){b.cancel()},1E3*a.delay);return b}});
if(z)A.methods({_check:function(){return z.checkPermission()},_request:function(a){z.requestPermission(a)},_create:function(a){try{a=z.createNotification(a.icon,a.title,a.text)}catch(b){throw"Notifications.createNotification \u2014 access denied";}return a}});else{var B=/\{\{(.*?)\}\}/g,C=[],D=function(a,b){this.a=x.createElement("div");this.a.innerHTML=("#"==a.charAt(0)?x.getElementById(a.substr(1)).innerHTML:a).replace(B,function(a,d){return(new Function("notify,v,u","try{v="+d+'}catch(e){} return v===u?"":v'))(b)});
x.body.appendChild(this.a)};D.d=function(){for(var a=5,b=0,c=C.length;b<c;b++)C[b].a.style.top=a+"px",a+=C[b].a.offsetHeight+5};D.prototype={show:function(){if(this.a){var a=this,b=a.a.style;C.push(a);b.right="5px";b.position="fixed";b.display="block";D.d();a.a.onclick=function(){a.onclick.call(a,{type:"click",target:a,currentTarget:a})}}},cancel:function(){if(this.a){for(var a=0,b=C.length;a<b;a++)C[a]===this&&(C.splice(a,1),D.d());this.a.onclick=f;this.a.parentNode.removeChild(this.a);this.a=f}},
onclick:function(){}};A.methods({hasRight:function(){return!!this._tpl},_create:function(a){return new D(this._tpl,a)}})}y.scope("OS",new (y.OS=A));var E=document,F=Jinn;function G(){}var H=/\bicon\b/,I=/^data/,J,K,L=f,M=new Image,N=0,O={val:L,fps:2,iconX:0,iconY:0,iconW:16,iconH:16};function P(a){for(var b=E.getElementsByTagName("link"),c=b.length;c--;)if(H.test(b[c].getAttribute("rel"))&&!0===a(b[c]))return b[c]}
function Q(a){R.b();P(function(a){a.parentNode.removeChild(a)});var b=E.createElement("link");b.rel="icon";b.type="image/png";b.href=a;E.getElementsByTagName("head")[0].appendChild(b)}var S=E.createElement("canvas"),T=S.toDataURL&&!!~S.toDataURL("image/png").indexOf("data:image/png");
O.shape=function(a,b,c){var d=15.5,b=99<b?(d+=0.5,"99+"):b;a.font=(F.h?"bold ":"")+"9px arial";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=2;a.shadowColor="rgba(0,0,0,.5)";a.fillStyle=c?"#fc3":"#fff";a.textAlign="right";a.fillText(b,d,15);a.fillText(b,d,15);a.fillText(b,d,15)};
var R={b:function(){R.b=G;R.f=1;var a=P(function(){return!0});a&&(K=a.href,R.opt("src",O.src||K))},src:function(a){return R.opt("src",a)},shape:function(a){R.opt("shape",a);return this},opt:function(a,b){var c=R.f||O.val||"shape"==a;if("string"==typeof a){if(b===e)return O[a];O[a]=b}else for(var d in a)O[d]=a[d],c=c||"shape"==d;b=O.val;if(c){var r=b;if(T&&(M.src!=O.src||L!=r))if(R.b(),S.width=S.height=16,M.src=O.src,M.onload=function(){function a(){var b=S.getContext("2d");b.clearRect(0,0,16,16);
b.drawImage(M,0,0,M.width,M.height,O.iconX,O.iconY,O.iconW,O.iconH);O.shape(b,r,N,O);Q(S.toDataURL());O.fps<=++N&&(N=0)}clearInterval(J);r===f||r===e||!O.fps?N=0:J=setInterval(a,~~(1E3/O.fps+0.5));r===f||r===e?Q(O.src):a()},I.test(M.src)?(M.crossOrigin=f,M.removeAttribute("crossOrigin")):M.crossOrigin="anonymous",M.width)M.onload()}b!==L&&F.emit("bubble:val",b);L=b},set:function(a){R.b();R.opt("val",a)},revert:function(){R.opt("src",K)},reset:function(){R.opt({src:K,val:f})},clear:function(){R.opt("val",
f)}};F.OS.Bubble=R;F.scope("OS").bubble=function(a,b){if("object"==typeof a&&a!==f)R.opt(a);else if(a in R)R[a](b);else R.set(a);return F};F.on("bubble:val",function(a){R.set(a)});window.ajs&&ajs.loaded&&ajs.loaded("{Jinn}Jinn.min");"function"===typeof define&&define.amd&&define("Jinn",[],function(){return window.Jinn||{}});})()