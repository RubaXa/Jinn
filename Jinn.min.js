/**!
 * Jinn -- Notifications center
 * https://github.com/RubaXa/Jinn#readme
 *
 * @author	RubaXa	<trash@rubaxa.org>
 * @build	Jinn.OS, Jinn.bubble
 * @example
 *
 * 	Jinn
 * 		.bubble(10)
 * 		.scope('menu')
 * 			.bubble(5)
 * 			.say({ ... })
 * 		.store('key', '...') // set
 * 	;
 *
 *  // Jinn.access -- should be invoked on user action
 * 	Jinn.access(function (){
 * 		var notify = Jinn.say({ icon: '..', title: '...', text: '...' });
 * 		notify.onclick = function (){   };
 * 	});
 *
 * 	var val = Jinn.store('key'); // get
 * 	Jinn.store('key', null); // remove
 */
(function(){var m=null;
(function(p,h,i){function n(){var a,d,b;for(a in o){d=c.store("__event."+a);for(b=o[a].length;b--;)o[a][b](d)}q=0}function s(){q||(q=1,clearTimeout(t),t=setTimeout(n,10))}function g(){}function l(){}var h=navigator.userAgent.toLowerCase(),b={scope:"OS"},f={},o={},t,q;g.ext=function(a){function d(){this.__lego.apply(this,arguments)}var b;l.prototype=this.fn;d.prototype=d.fn=new l;d.ext=g.ext;d.methods=g.methods;for(b in a)d.fn[b]=a[b];return d};g.methods=function(a){for(var d in a)this.fn[d]=a[d];
return this};g.prototype=g.fn={ALLOWED:0,NOT_ALLOWED:1,DENIED:2,_opts:{},__lego:l,_check:function(){return this.ALLOWED},_request:function(a){a()},_ext:function(a){for(var d in this._opts)a[d]===i&&(a[d]=this._opts[d]);return a},opt:function(a,d){var b=this;if(d!==i)b._opts[a]=d;else if("object"==typeof a)for(d in a)b._opts[d]=a[d];else b=b._opts[a];return b},access:function(a){if(a){if(!a.c){var b=this;a.c=function(){a.call(b)}}this.hasRight()?a.c():this._request(a.c)}else return this._check()},
hasRight:function(){return this.access()==this.ALLOWED},add:l,say:function(){return this.add.apply(this,arguments)},bubble:function(){},end:function(){return c}};var c={API:g,opt:function(a,d){if(d===i)return b[a];b[a]=d;return c},on:function(a,b){o[a]||(o[a]=[]);o[a].push(b);return c},off:function(a,b){if(a in o)for(var j=o[a],e=j.length;e--;)if(j[e]===b){j.splice(e,1);break}return c},emit:function(a,b){c.store("__event."+a,b);s()},scope:function(a,d){var j=c;if(a==i)j=c.scope(b.scope);else if(d!==
i)f[a]=d;else if(a in f)j=f[a];else throw'Jinn: scope "'+a+'" is undefined';return j},e:function(a,b,j){if(a){var e=a.addEventListener?"":"on";a[e?"attachEvent":"addEventListener"](e+b,j,!1)}return c}},k=["hasRight","access","bubble","add","say"],r=k.length;for(;r--;)(function(a){c[a]=function(){var b=c.scope(),j=b[a].apply(b,arguments);return j===b?c:j}})(k[r]);c.store=function(a,b){var j=c,e=c.scope("__store");b===m?e.remove("__jinn."+a):b===i?j=e.get("__jinn."+a):e.set("__jinn."+a,b);return j};
(function(a,b){c.scope("__store",{get:function(c){return a?a.getItem(c):b[c]},set:function(c,e){a?a.setItem(c,e):b[c]=e},remove:function(c){delete b[c];a&&a.removeItem(c)}})})(p.localStorage,{});c[(h.match(/webkit/)||h.match(/opera/)||h.match(/msie/)||0>h.indexOf("compatible")&&h.match(/mozilla/)||[])[0]]=!0;c.webkit&&(c[(h.match(/chrome/)||h.match(/safari/)||[])[0]]=!0);c.e(p,"storage",s);p.Jinn=c})(window,document);
(function(p,h,i,n){p=i.API.ext({_tpl:"#JinnOSTpl",_opts:{title:"",text:"",delay:60},tpl:function(b){this._tpl=b;return this},add:function(b){"string"==typeof b&&(b={title:b});this._ext(b);var f=this._create(b);f.show();b.delay&&setTimeout(function(){f.cancel()},1E3*b.delay);return f}});if(n)p.methods({_check:function(){return n.checkPermission()},_request:function(b){n.requestPermission(b)},_create:function(b){return n.createNotification(b.icon,b.title,b.text)}});else{var s=/\{\{(.*?)\}\}/g,g=[],
l=function(b,f){this.a=h.createElement("div");this.a.innerHTML=("#"==b.charAt(0)?h.getElementById(b.substr(1)).innerHTML:b).replace(s,function(b,g){return(new Function("notify,v,u","try{v="+g+'}catch(e){} return v===u?"":v'))(f)});h.body.appendChild(this.a)};l.d=function(){for(var b=5,f=0,h=g.length;f<h;f++)g[f].a.style.top=b+"px",b+=g[f].a.offsetHeight+5};l.prototype={show:function(){if(this.a){var b=this,f=b.a.style;g.push(b);f.right="5px";f.position="fixed";f.display="block";l.d();b.a.onclick=
function(){b.onclick.call(b,{type:"click",target:b,currentTarget:b})}}},cancel:function(){if(this.a){for(var b=0,f=g.length;b<f;b++)g[b]===this&&(g.splice(b,1),l.d());this.a.onclick=m;this.a.parentNode.removeChild(this.a);this.a=m}},onclick:function(){}};p.methods({hasRight:function(){return!!this._tpl},_create:function(b){return new l(this._tpl,b)}})}i.scope("OS",new (i.OS=p))})(window,document,Jinn,window.webkitNotifications);
(function(p,h,i,n){function s(b){if(j&&(k.src!=a.src||c!=b))if(e.b(),d.width=d.height=16,k.src=a.src,k.onload=function(){function c(){var e=d.getContext("2d");e.clearRect(0,0,16,16);e.drawImage(k,0,0,k.width,k.height,a.iconX,a.iconY,a.iconW,a.iconH);a.shape(e,b,r,a);g(d.toDataURL());a.fps<=++r&&(r=0)}clearInterval(t);b===m||b===n||!a.fps?r=0:t=setInterval(c,~~(1E3/a.fps+0.5));b===m||b===n?g(a.src):c()},o.test(k.src)?(k.crossOrigin=m,k.removeAttribute("crossOrigin")):k.crossOrigin="anonymous",k.width)k.onload()}
function g(b){e.b();l(function(a){a.parentNode.removeChild(a)});var a=h.createElement("link");a.rel="icon";a.type="image/png";a.href=b;h.getElementsByTagName("head")[0].appendChild(a)}function l(a){for(var b=h.getElementsByTagName("link"),c=b.length;c--;)if(f.test(b[c].getAttribute("rel"))&&!0===a(b[c]))return b[c]}function b(){}var f=/\bicon\b/,o=/^data/,t,q,c=m,k=new Image,r=0,a={val:c,fps:2,iconX:0,iconY:0,iconW:16,iconH:16},d=h.createElement("canvas"),j=d.toDataURL&&!!~d.toDataURL("image/png").indexOf("data:image/png");
a.shape=function(a,b,c){var e=15.5,b=99<b?(e+=0.5,"99+"):b;a.font=(i.g?"bold ":"")+"9px arial";a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=2;a.shadowColor="rgba(0,0,0,.5)";a.fillStyle=c?"#fc3":"#fff";a.textAlign="right";a.fillText(b,e,15);a.fillText(b,e,15);a.fillText(b,e,15)};var e={b:function(){e.b=b;e.f=1;var c=l(function(){return!0});c&&(q=c.href,e.opt("src",a.src||q))},src:function(a){return e.opt("src",a)},shape:function(a){e.opt("shape",a);return this},opt:function(b,d){var f=e.f||a.val||
"shape"==b;if("string"==typeof b){if(d===n)return a[b];a[b]=d}else for(var g in b)a[g]=b[g],f=f||"shape"==g;d=a.val;f&&s(d);d!==c&&i.emit("bubble:val",d);c=d},set:function(a){e.b();e.opt("val",a)},revert:function(){e.opt("src",q)},reset:function(){e.opt({src:q,val:m})},clear:function(){e.opt("val",m)}};i.OS.Bubble=e;i.scope("OS").bubble=function(a,b){if("object"==typeof a&&a!==m)e.opt(a);else if(a in e)e[a](b);else e.set(a);return i};i.on("bubble:val",function(a){e.set(a)})})(window,document,Jinn);
window.ajs&&ajs.loaded&&ajs.loaded("{Jinn}Jinn.min");"function"===typeof define&&define.amd&&define("Jinn",[],function(){return window.Jinn||{}});
})()