/**!
 * Jinn -- Notifications center
 * https://github.com/RubaXa/Jinn#readme
 *
 * @author	RubaXa	<trash@rubaxa.org>
 * @build	Jinn.OS, Jinn.bubble
 * @example
 *
 * 	Jinn
 * 		.bubble(10)
 * 		.scope('menu')
 * 			.bubble(5)
 * 			.say({ ... })
 * 		.store('key', '...') // set
 * 	;
 *
 *  // Jinn.access -- should be invoked on user action
 * 	Jinn.access(function (){
 * 		var notify = Jinn.say({ icon: '..', title: '...', text: '...' });
 * 		notify.onclick = function (){   };
 * 	});
 *
 * 	var val = Jinn.store('key'); // get
 * 	Jinn.store('key', null); // remove
 */
(function(p,f,h){var l=function(){},g=function(b){this._api=b};f=navigator.userAgent.toLowerCase();var j={scope:"OS"},n={},a={},e,q,k=function(){q||(q=1,clearTimeout(e),e=setTimeout(t,10))},t=function(){var b,c,r;for(b in a){c=d.store("__event."+b);for(r=a[b].length;r--;)a[b][r](c)}q=0};g.ext=function(b){var c=function(){this.__lego.apply(this,arguments)},a;l.prototype=this.fn;c.prototype=c.fn=new l;c.ext=g.ext;c.methods=g.methods;for(a in b)c.fn[a]=b[a];return c};g.methods=function(b){for(var c in b)this.fn[c]=
b[c];return this};g.prototype=g.fn={ALLOWED:0,NOT_ALLOWED:1,DENIED:2,_opts:{},__lego:l,_check:function(){return this.ALLOWED},_request:function(b){b()},_ext:function(b){for(var c in this._opts)b[c]===h&&(b[c]=this._opts[c]);return b},opt:function(b,c){var a=this;if(c!==h)a._opts[b]=c;else if("object"==typeof b)for(c in b)a._opts[c]=b[c];else a=a._opts[b];return a},access:function(b){if(b){if(!b.j){var c=this;b.j=function(){b.call(c)}}this.hasRight()?b.j():this._request(b.j)}else return this._check()},
hasRight:function(){return this.access()==this.ALLOWED},hasAccessDenied:function(){return this.access()==this.DENIED},add:l,say:function(){return this.add.apply(this,arguments)},bubble:function(){},end:function(){return d}};var d={API:g,opt:function(b,c){if(c===h)return j[b];j[b]=c;return d},on:function(b,c){a[b]||(a[b]=[]);a[b].push(c);return d},off:function(b,c){if(b in a)for(var r=a[b],e=r.length;e--;)if(r[e]===c){r.splice(e,1);break}return d},emit:function(b,c){d.store("__event."+b,c);k()},scope:function(b,
c){var a=d;if(b==h)a=d.scope(j.scope);else if(c!==h)n[b]=c;else if(b in n)a=n[b];else throw'Jinn: scope "'+b+'" is undefined';return a},addEvent:function(b,c,a){if(b){var d=b.addEventListener?"":"on";b[d?"attachEvent":"addEventListener"](d+c,a,!1)}}},u="hasRight hasAccessDenied access bubble add say".split(" "),v=u.length;for(;v--;)(function(b){d[b]=function(){var c=d.scope(),a=c[b].apply(c,arguments);return a===c?d:a}})(u[v]);d.store=function(b,c){var a=d,e=d.scope("__store");null===c?e.remove("__jinn."+
b):c===h?a=e.get("__jinn."+b):e.set("__jinn."+b,c);return a};var m,s={};try{m=p.localStorage}catch(w){}d.scope("__store",{get:function(b){return m?m.getItem(b):s[b]},set:function(b,c){m?m.setItem(b,c):s[b]=c},remove:function(b){delete s[b];m&&m.removeItem(b)}});d[(f.match(/webkit/)||f.match(/opera/)||f.match(/msie/)||0>f.indexOf("compatible")&&f.match(/mozilla/)||[])[0]]=!0;d.webkit&&(d[(f.match(/chrome/)||f.match(/safari/)||[])[0]]=!0);d.addEvent(p,"storage",k);p.Jinn=d})(window,document);
(function(p,f,h,l){p=h.API.ext({_tpl:"#JinnOSTpl",_opts:{title:"",text:"",delay:60},tpl:function(a){this._tpl=a;return this},add:function(a){"string"==typeof a&&(a={title:a});this._ext(a);var e=this._create(a);e.show();a.delay&&setTimeout(function(){e.cancel()},1E3*a.delay);return e}});if(l)p.methods({_check:function(){return l.checkPermission()},_request:function(a){l.requestPermission(a)},_create:function(a){try{a=l.createNotification(a.icon,a.title,a.text)}catch(e){throw"Notifications.createNotification \u2014 access denied";
}return a}});else{var g=/\{\{(.*?)\}\}/g,j=[],n=function(a,e){if(/^#/.test(a)&&(a=f.getElementById(a.substr(1))))a=a.innerHTML;a&&(this.el=f.createElement("div"),this.el.innerHTML=a.replace(g,function(a,f){return(new Function("notify,v,u","try{v="+f+'}catch(e){} return v===u?"":v'))(e)}),f.body.appendChild(this.el))};n.redraw=function(){for(var a=5,e=0,f=j.length;e<f;e++)j[e].el.style.top=a+"px",a+=j[e].el.offsetHeight+5};n.prototype={show:function(){if(this.el){var a=this,e=a.el.style;j.push(a);
e.right="5px";e.position="fixed";e.display="block";n.redraw();a.el.onclick=function(){a.onclick.call(a,{type:"click",target:a,currentTarget:a})}}},cancel:function(){if(this.el){for(var a=0,e=j.length;a<e;a++)j[a]===this&&(j.splice(a,1),n.redraw());this.el.onclick=null;this.el.parentNode.removeChild(this.el);this.el=null}},onclick:function(){}};p.methods({hasRight:function(){return!!this._tpl},_create:function(a){return new n(this._tpl,a)}})}h.scope("OS",new (h.OS=p))})(window,document,Jinn,window.webkitNotifications);
(function(p,f,h,l){var g=function(){},j=/(^|\s)icon(\s|$)/,n=/^data/,a,e,q=null,k=new Image,t=0,d={val:q,fps:2,iconX:0,iconY:0,iconW:16,iconH:16},u=function(b){for(var a=f.getElementsByTagName("link"),d=a.length;d--;)if(j.test(a[d].getAttribute("rel"))&&!0===b(a[d]))return a[d]},v=function(c){b.init();u(function(b){b.parentNode.removeChild(b)});var a=f.createElement("link");a.rel="icon";a.type="image/png";a.href=c;f.getElementsByTagName("head")[0].appendChild(a)},m=f.createElement("canvas"),s;a:{try{s=
!!~m.toDataURL("image/png").indexOf("data:image/png");break a}catch(w){}s=void 0}d.shape=function(b,a,d){var e=15.5;a=99<a?(e+=0.5,"99+"):a;b.font=(h.webkit?"bold ":"")+"9px arial";b.shadowOffsetX=0;b.shadowOffsetY=0;b.shadowBlur=2;b.shadowColor="rgba(0,0,0,.5)";b.fillStyle=d?"#fc3":"#fff";b.textAlign="right";b.fillText(a,e,15);b.fillText(a,e,15);b.fillText(a,e,15)};var b={init:function(){b.init=g;b.ready=1;var a=u(function(){return!0});a&&(e=a.href,b.opt("src",d.src||e))},src:function(a){return b.opt("src",
a)},shape:function(a){b.opt("shape",a);return this},opt:function(c,e){var f=b.ready||d.val||"shape"==c;if("string"==typeof c){if(e===l)return d[c];d[c]=e}else for(var j in c)d[j]=c[j],f=f||"shape"==j;e=d.val;if(f){var g=e;if(s&&(k.src!=d.src||q!=g))if(b.init(),m.width=m.height=16,k.src=d.src,k.onload=function(){function b(){var a=m.getContext("2d");a.clearRect(0,0,16,16);a.drawImage(k,0,0,k.width,k.height,d.iconX,d.iconY,d.iconW,d.iconH);d.shape(a,g,t,d);v(m.toDataURL());d.fps<=++t&&(t=0)}clearInterval(a);
null===g||g===l||!d.fps?t=0:a=setInterval(b,~~(1E3/d.fps+0.5));null===g||g===l?v(d.src):b()},n.test(k.src)?(k.crossOrigin=null,k.removeAttribute("crossOrigin")):k.crossOrigin="anonymous",k.width)k.onload()}e!==q&&h.emit("bubble:val",e);q=e},set:function(a){b.init();b.opt("val",a)},revert:function(){b.opt("src",e)},reset:function(){b.opt({src:e,val:null})},clear:function(){b.opt("val",null)}};h.OS.Bubble=b;h.scope("OS").bubble=function(a,d){if("object"==typeof a&&null!==a)b.opt(a);else if(a in b)b[a](d);
else b.set(a);return h};h.on("bubble:val",function(a){b.set(a)})})(window,document,Jinn);"undefined"!==typeof ajs&&ajs.loaded&&ajs.loaded("{jinn}Jinn.min");"function"===typeof define&&define.amd&&define("Jinn",[],function(){return window.Jinn||{}});